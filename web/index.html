<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        pmoon's Audio Player using AWS SDK for JavaScript in the Browser
    </title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel='stylesheet' href='assets/css/style.css' />
    <link rel='stylesheet' href='assets/css/pm-player.css' />
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.0.15.min.js"></script>
    <script src='assets/js/jstree.min.js'></script>
    <script src='assets/js/pm-config.js'></script>
</head>

<body>
    <div id="imgdiv" class="glyphicon glyphicon-headphones">
        <img id="img" class="hide"></img>
    </div>
    <div>
        <audio controls></audio>
    </div>
    <div>
        <input type="checkbox" id="repeatCheck"></input>
        Repeat?
    </div>
    <div>
        <input type="checkbox" id="randomCheck"></input>
        Random?
    </div>
    <div id="jstree">
    </div>
    <div id="fb-root"></div>
    <script type="text/javascript">
    AWS.config.logger = console;
    AWS.config.region = pmConfig.region;

    var bkt = new AWS.S3({
        params: {
            Bucket: pmConfig.bucket
        }
    });
    var bktSync = new AWS.S3({
        params: {
            Bucket: pmConfig.bucket
        },
        httpOptions: {
            xhrAsync: false
        }
    });

    var fbUserId;
    var topNodeId = '__top_node__';
    var stateObjectKey = '__player_state__';
    var state = {};
    var playingId;
    var idToStartPlaying;
    var imageParent, imageUrls = new Array(),
        imageNextIndex, interval;
    var audioNodeIds;
    var extentions = {
        audio: [/.mp3$/, /.ogg$/, /.m4a$/],
        image: [/.png$/, /.jpe?g$/, /.giff?$/, /.bmp$/]
    };

    function isKeyType(key, type) {
        var lk = key.toLowerCase();
        var isKeyType = false;
        $.each(extentions[type], function(i, regex) {
            if (regex.test(lk)) {
                isKeyType = true;
                return false;
            }
        });
        return isKeyType;
    }

    function cacheState(event) {
        state.repeat = $('#repeatCheck').prop('checked');
        state.random = $('#randomCheck').prop('checked');
    }

    function storeState() {
        if (playingId) {
            state.playingKey = $('#jstree').jstree('get_path', playingId, '/');
        }
        console.log(state);
        bktSync.putObject({
            Key: stateObjectKey,
            Body: JSON.stringify(state)
        }).send();
    }

    function fetchState() {
        bkt.getObject({
            Key: stateObjectKey
        }, fetchStateCallback);
    }

    function fetchStateCallback(err, data) {
        if (err) {
            console.log('Error: failed to get previous state')
        } else {
            state = JSON.parse(data.Body);
            console.log(state);
            $('#repeatCheck').prop('checked', state.repeat);
            $('#randomCheck').prop('checked', state.random);
        }

        //load song list
        audioNodeIds = new Array();
        bkt.listObjects(null, function(err, data) {
            if (err) {
                console.log(err);
            } else {
                var treeData = new Array();
                $.each(data.Contents, function(index, v) {
                    var key = v.Key;

                    if (key !== stateObjectKey) {
                        var pieces = key.split('/');
                        var node = treeData;
                        for (var i = 0; i < pieces.length; i++) {
                            node = getChildNodeByText(node, pieces[i]);
                            if (index === 0 && i === 0) {
                                node.id = topNodeId;
                            }
                            if (isKeyType(pieces[i], 'audio')) {
                                node.type = 'audio';
                                node.id = 'audio_' + index + '_' + i;
                                audioNodeIds.push(node.id);
                                //if the current node is the song stored in the state, 
                                //note the id to start playing once the tree's ready
                                if (state.playingKey && key === state.playingKey) {
                                    idToStartPlaying = node.id;
                                }
                            } else if (isKeyType(pieces[i], 'image')) {
                                node.type = 'image';
                            }
                        }
                    }
                });
                $('#jstree').jstree({
                    'plugins': ['types'], //'dnd'], drag n drop not working well for touch screen devices. should fix when playlist feature is added.
                    'core': {
                        'themes': {
                            'variant': 'small',
                            'stripes': true,
                            'icons': true
                        },
                        'data': treeData
                    },
                    'types': {
                        'default': {
                            'icon': 'glyphicon glyphicon-folder-close'
                        },
                        'audio': {
                            'icon': 'glyphicon glyphicon-headphones',
                            'valid_children': []
                        },
                        'image': {
                            'icon': 'glyphicon glyphicon-picture',
                            'valid_children': []
                        }
                    }
                });

                //add event listener to play the selected item when selection changes
                $('#jstree').on('changed.jstree', function(e, data) {
                    if (data.selected.length > 0) {
                        playId(data.selected[0]);
                    }
                });

                //add event listener to start playing the song stored in previous state when the tree is ready
                $('#jstree').on('ready.jstree', function(err, data) {
                    if (idToStartPlaying) {
                        playId(idToStartPlaying);
                    }
                });
            }
        });
    }

    function playId(id) {
        //return true if node is audio and player src is set.
        //return false if node is not audio.
        var key = $('#jstree').jstree('get_path', id, '/');
        if (isKeyType(key, 'audio')) {
            var params = {
                Key: key,
                Expires: 9000
            };
            var url = bkt.getSignedUrl('getObject', params);
            $('audio').attr('src', url);
            playingId = id;

            //visually select the next audio without triggering the select event
            $('#jstree').jstree('deselect_all', true);
            $('#jstree').jstree('select_node', id, true, false);

            //display images under the same parent as the audio file
            var parent = $('#jstree').jstree('get_parent', id);
            if (imageParent != parent) {
                imageParent = parent;
                loadImagesForParent(parent);
            }
            return true;
        } else {
            console.log('not audio: ' + key);
            return false;
        }
    }

    function loadImagesForParent(parentNode) {
        var children = $('#jstree').jstree('get_children_dom', parentNode);
        imageUrls = new Array();
        imageNextIndex = 0;
        children.each(function() {
            var key = $('#jstree').jstree('get_path', $(this).attr('id'), '/');
            if (isKeyType(key, 'image')) {
                var url = bkt.getSignedUrl('getObject', {
                    Key: key
                });
                imageUrls.push(url);
            }
        });
    }

    function getChildNodeByText(node, text) {
        //gets or creates tree structure for jstree to render
        if (!(node instanceof Array)) {
            node = node.children;
        }
        if (node.length > 0) {
            for (var i = 0; i < node.length; i++) {
                if (node[i].text === text) {
                    return node[i];
                }
            }
        }
        node.push({
            text: text,
            children: []
        });
        return node[node.length - 1];
    }

    //initialize tree and load music list

    function init() {

        //cache state on change
        $('#repeatCheck').on('change', cacheState);
        $('#randomCheck').on('change', cacheState);
        $('audio').on('play', function(event) {
            $('audio').prop('autoplay', true);
            $('audio').off('play');
        });
        $(window).on('unload', storeState);

        //logic for loading the next song
        $('audio').on('ended', function() {
            if (repeatCheck.checked) {
                $('audio').trigger('play');
            } else if (randomCheck.checked) {
                var randIndex = Math.floor((Math.random() * audioNodeIds.length));
                var randId = audioNodeIds[randIndex];
                playId(randId);
            } else if (playingId) {
                var nextId = $('#jstree').jstree('get_next_dom', playingId).attr('id');
                while (nextId && !playId(nextId)) {
                    if ($('#jstree').jstree('is_parent', nextId)) {
                        $('#jstree').jstree('open_node', nextId);
                    }
                    nextId = $('#jstree').jstree('get_next_dom', nextId).attr('id');
                    if (!nextId) {
                        nextId = topNodeId;
                    }
                }
            }
        });

        //setup interval for rotating album images contained in the same folder as the music being played
        interval = setInterval(function() {

            if (imageUrls.length > 0) {
                $('#img').removeClass('hide');
                $('#img').addClass('show');
                $('#imgdiv').removeClass('glyphicon-headphones');

                if (imageNextIndex >= imageUrls.length) {
                    imageNextIndex = 0;
                }
                var url = imageUrls[imageNextIndex];
                if ($('#img').attr('src') !== url) {
                    $('#img').attr('src', url);
                }
                imageNextIndex++;
            } else {
                $('#img').removeClass('show');
                $('#img').addClass('hide');
                $('#imgdiv').addClass('glyphicon-headphones');
            }
        }, 5000);

        //fetch state and then load the library
        fetchState();
    }
    /*!
     * Login to your application using Facebook.
     * Uses the Facebook SDK for JavaScript available here:
     * https://developers.facebook.com/docs/javascript/gettingstarted/
     */
    window.fbAsyncInit = function() {
        FB.init({
            appId: pmConfig.facebookAppId
        });
        FB.login(function(response) {
            try {
                AWS.config.credentials = new AWS.WebIdentityCredentials({
                    ProviderId: 'graph.facebook.com',
                    RoleArn: pmConfig.roleArn,
                    WebIdentityToken: response.authResponse.accessToken,
                    DurationSeconds: 900
                });
                bkt.config.credentials = AWS.config.credentials;
                bktSync.config.credentials = AWS.config.credentials;
                fbUserId = response.authResponse.userID;
                init();
            } catch (e) {
                window.alert(e);
            }
        });
    };
    // Load the Facebook SDK asynchronously
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>
</body>

</html>